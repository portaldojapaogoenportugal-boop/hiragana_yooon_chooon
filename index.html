<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hiragana Youon Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f9;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .app {
      max-width: 480px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 8px;
    }
    .kana-display {
      font-size: 3.2rem;
      text-align: center;
      margin: 12px 0 8px;
      word-break: keep-all;
    }
    .question-info {
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      color: #555;
    }
    .score-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      background: #e0e0ff;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s ease;
    }
    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }
    .btn-small {
      font-size: 0.85rem;
      padding: 6px 10px;
      width: auto;
      display: inline-block;
    }
    .feedback {
      margin-top: 10px;
      font-size: 0.95rem;
      min-height: 1.4em;
    }
    .feedback.correct { color: #0c7a3a; }
    .feedback.wrong  { color: #b91c1c; }

    .badge-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #312e81;
    }
    .mistake-list {
      font-size: 0.85rem;
      max-height: 150px;
      overflow-y: auto;
    }
    .mistake-item {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
    }
  </style>
</head>

<body>
<div class="app">

  <div class="card">
    <h1>Hiragana Youon Quiz</h1>
    <div class="subtitle">
      10 questions per round ¬∑ 3 choices ¬∑ youon & long vowels
    </div>

    <div class="question-info">
      <div>Question: <span id="questionNumber">0</span> / 10</div>
      <div>Round: <span id="roundCount">0</span></div>
    </div>

    <div class="score-info">
      <div>Score: <span id="score">0</span></div>
      <div>Streak: <span id="streak">0</span> (Max: <span id="maxStreak">0</span>)</div>
    </div>

    <div class="kana-display" id="kanaDisplay">„Éº</div>

    <div style="text-align:center;">
      <button class="btn btn-small" id="playAudioBtn">üîä Play audio</button>
    </div>

    <button class="btn" id="choice1"></button>
    <button class="btn" id="choice2"></button>
    <button class="btn" id="choice3"></button>

    <div class="feedback" id="feedback"></div>

    <div id="roundEnd" style="display:none; margin-top:16px;">
      <strong>Round finished!</strong><br>
      Correct: <span id="roundCorrect">0</span> / 10<br>
      <button class="btn btn-primary btn-small" id="nextRoundBtn">Next round</button>
    </div>
  </div>

  <div class="card">
    <div><strong>Badges</strong></div>
    <div class="badge-list" id="badgeList"></div>
  </div>

  <div class="card">
    <div><strong>Mistakes</strong></div>
    <div class="mistake-list" id="mistakeList"></div>
  </div>

</div>

<script>
/* ==========================
   Youon & long-vowel kana list
   ========================== */
const KANA_LIST = [
  { id: "kya",  char: "„Åç„ÇÉ",   romaji: "kya"  },
  { id: "kyu",  char: "„Åç„ÇÖ",   romaji: "kyu"  },
  { id: "kyo",  char: "„Åç„Çá",   romaji: "kyo"  },
  { id: "sha",  char: "„Åó„ÇÉ",   romaji: "sha"  },
  { id: "shu",  char: "„Åó„ÇÖ",   romaji: "shu"  },
  { id: "sho",  char: "„Åó„Çá",   romaji: "sho"  },
  { id: "cha",  char: "„Å°„ÇÉ",   romaji: "cha"  },
  { id: "chu",  char: "„Å°„ÇÖ",   romaji: "chu"  },
  { id: "cho",  char: "„Å°„Çá",   romaji: "cho"  },
  { id: "nya",  char: "„Å´„ÇÉ",   romaji: "nya"  },
  { id: "nyu",  char: "„Å´„ÇÖ",   romaji: "nyu"  },
  { id: "nyo",  char: "„Å´„Çá",   romaji: "nyo"  },
  { id: "hya",  char: "„Å≤„ÇÉ",   romaji: "hya"  },
  { id: "hyu",  char: "„Å≤„ÇÖ",   romaji: "hyu"  },
  { id: "hyo",  char: "„Å≤„Çá",   romaji: "hyo"  },
  { id: "mya",  char: "„Åø„ÇÉ",   romaji: "mya"  },
  { id: "myu",  char: "„Åø„ÇÖ",   romaji: "myu"  },
  { id: "myo",  char: "„Åø„Çá",   romaji: "myo"  },
  { id: "rya",  char: "„Çä„ÇÉ",   romaji: "rya"  },
  { id: "ryu",  char: "„Çä„ÇÖ",   romaji: "ryu"  },
  { id: "ryo",  char: "„Çä„Çá",   romaji: "ryo"  },
  { id: "gya",  char: "„Åé„ÇÉ",   romaji: "gya"  },
  { id: "gyu",  char: "„Åé„ÇÖ",   romaji: "gyu"  },
  { id: "gyo",  char: "„Åé„Çá",   romaji: "gyo"  },
  { id: "ja",   char: "„Åò„ÇÉ",   romaji: "ja"   },
  { id: "ju",   char: "„Åò„ÇÖ",   romaji: "ju"   },
  { id: "jo",   char: "„Åò„Çá",   romaji: "jo"   },
  { id: "bya",  char: "„Å≥„ÇÉ",   romaji: "bya"  },
  { id: "byu",  char: "„Å≥„ÇÖ",   romaji: "byu"  },
  { id: "byo",  char: "„Å≥„Çá",   romaji: "byo"  },
  { id: "pya",  char: "„Å¥„ÇÉ",   romaji: "pya"  },
  { id: "pyu",  char: "„Å¥„ÇÖ",   romaji: "pyu"  },
  { id: "pyo",  char: "„Å¥„Çá",   romaji: "pyo"  },
  { id: "kyaa", char: "„Åç„ÇÉ„ÅÇ", romaji: "kyaa" },
  { id: "kyuu", char: "„Åç„ÇÖ„ÅÜ", romaji: "kyuu" },
  { id: "kyoo", char: "„Åç„Çá„ÅÜ", romaji: "kyoo" },
  { id: "shaa", char: "„Åó„ÇÉ„ÅÇ", romaji: "shaa" },
  { id: "shuu", char: "„Åó„ÇÖ„ÅÜ", romaji: "shuu" },
  { id: "shoo", char: "„Åó„Çá„ÅÜ", romaji: "shoo" },
  { id: "chaa", char: "„Å°„ÇÉ„ÅÇ", romaji: "chaa" },
  { id: "chuu", char: "„Å°„ÇÖ„ÅÜ", romaji: "chuu" },
  { id: "choo", char: "„Å°„Çá„ÅÜ", romaji: "choo" },
  { id: "nyaa", char: "„Å´„ÇÉ„ÅÇ", romaji: "nyaa" },
  { id: "nyuu", char: "„Å´„ÇÖ„ÅÜ", romaji: "nyuu" },
  { id: "nyoo", char: "„Å´„Çá„ÅÜ", romaji: "nyoo" },
  { id: "hyaa", char: "„Å≤„ÇÉ„ÅÇ", romaji: "hyaa" },
  { id: "hyuu", char: "„Å≤„ÇÖ„ÅÜ", romaji: "hyuu" },
  { id: "hyoo", char: "„Å≤„Çá„ÅÜ", romaji: "hyoo" },
  { id: "myaa", char: "„Åø„ÇÉ„ÅÇ", romaji: "myaa" },
  { id: "myuu", char: "„Åø„ÇÖ„ÅÜ", romaji: "myuu" },
  { id: "myoo", char: "„Åø„Çá„ÅÜ", romaji: "myoo" },
  { id: "ryaa", char: "„Çä„ÇÉ„ÅÇ", romaji: "ryaa" },
  { id: "ryuu", char: "„Çä„ÇÖ„ÅÜ", romaji: "ryuu" },
  { id: "ryoo", char: "„Çä„Çá„ÅÜ", romaji: "ryoo" },
  { id: "gyaa", char: "„Åé„ÇÉ„ÅÇ", romaji: "gyaa" },
  { id: "gyuu", char: "„Åé„ÇÖ„ÅÜ", romaji: "gyuu" },
  { id: "gyoo", char: "„Åé„Çá„ÅÜ", romaji: "gyoo" },
  { id: "jaa",  char: "„Åò„ÇÉ„ÅÇ", romaji: "jaa"  },
  { id: "juu",  char: "„Åò„ÇÖ„ÅÜ", romaji: "juu"  },
  { id: "joo",  char: "„Åò„Çá„ÅÜ", romaji: "joo"  },
  { id: "byaa", char: "„Å≥„ÇÉ„ÅÇ", romaji: "byaa" },
  { id: "byuu", char: "„Å≥„ÇÖ„ÅÜ", romaji: "byuu" },
  { id: "byoo", char: "„Å≥„Çá„ÅÜ", romaji: "byoo" },
  { id: "pyaa", char: "„Å¥„ÇÉ„ÅÇ", romaji: "pyaa" },
  { id: "pyuu", char: "„Å¥„ÇÖ„ÅÜ", romaji: "pyuu" },
  { id: "pyoo", char: "„Å¥„Çá„ÅÜ", romaji: "pyoo" }
];

const TOTAL_PER_ROUND = 10;
const REVIEW_PER_ROUND = 3;
const STORAGE_KEY = "hiragana_youon_quiz_state_v1";

/* ==========================
   State
   ========================== */
let state = {
  learningQueue: [],
  index: 0,
  reviewPool: {},
  stats: {
    score: 0,
    currentStreak: 0,
    maxStreak: 0,
    totalSeen: 0,
    totalCorrect: 0,
    roundsPlayed: 0,
    badges: []
  },
  currentRound: {
    questionList: [],
    position: 0,
    correctThisRound: 0
  }
};

let currentQuestion = null;
let roundFinished = false;

/* ==========================
   Helpers
   ========================== */
function shuffle(array) {
  const arr = array.slice();
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function getKanaById(id) {
  return KANA_LIST.find(k => k.id === id);
}
function getRandomFromArray(arr, n) {
  const copy = arr.slice();
  const result = [];
  for (let i = 0; i < n && copy.length > 0; i++) {
    const idx = Math.floor(Math.random() * copy.length);
    result.push(copy[idx]);
    copy.splice(idx, 1);
  }
  return result;
}

/* ==========================
   Choices (duplicate romaji Èò≤Ê≠¢Áâà)
   ========================== */
function generateChoices(correctKana) {
  const correctRomaji = correctKana.romaji;

  // Ê≠£Ëß£„Å®Âêå„Åò romaji „ÇíÊåÅ„Å§„ÇÇ„ÅÆ„ÅØÂÖ®ÈÉ®ÊéíÈô§
  const allOthers = KANA_LIST.filter(
    k => k.id !== correctKana.id && k.romaji !== correctRomaji
  );

  const vowel = correctRomaji.slice(-1);
  const consonant = correctRomaji.slice(0, -1);

  // 1) Âêå„ÅòÊØçÈü≥„ÅßÂÄôË£ú
  let candidates = allOthers.filter(k => k.romaji.endsWith(vowel));

  // 2) Ë∂≥„Çä„Å™„Åë„Çå„Å∞Âêå„ÅòÈ†≠Â≠êÈü≥„ÅßË£úÂÖÖ
  if (candidates.length < 2 && consonant) {
    const byConsonant = allOthers.filter(k => k.romaji.startsWith(consonant));
    const already = new Set(candidates.map(k => k.id));
    byConsonant.forEach(k => {
      if (!already.has(k.id)) candidates.push(k);
    });
  }

  // 3) „Åæ„Å†Ë∂≥„Çä„Å™„Åë„Çå„Å∞ÊÆã„Çä„Åã„Çâ„É©„É≥„ÉÄ„É†
  if (candidates.length < 2) {
    const already = new Set(candidates.map(k => k.id));
    const fallback = allOthers.filter(k => !already.has(k.id));
    candidates = candidates.concat(fallback);
  }

  const distractors = getRandomFromArray(candidates, 2);

  return shuffle([
    { text: correctRomaji, correct: true },
    { text: distractors[0].romaji, correct: false },
    { text: distractors[1].romaji, correct: false }
  ]);
}

/* ==========================
   Round logic
   ========================== */
function initLearningQueue() {
  state.learningQueue = shuffle(KANA_LIST.map(k => k.id));
  state.index = 0;
}

function buildRoundQuestionList() {
  const q = [];
  const reviewIds = Object.keys(state.reviewPool);
  const numReview = Math.min(REVIEW_PER_ROUND, reviewIds.length);
  q.push(...getRandomFromArray(reviewIds, numReview));

  while (q.length < TOTAL_PER_ROUND) {
    if (state.index >= state.learningQueue.length) {
      state.learningQueue = shuffle(KANA_LIST.map(k => k.id));
      state.index = 0;
    }
    const id = state.learningQueue[state.index++];
    if (!q.includes(id)) q.push(id);
  }

  state.currentRound.questionList = shuffle(q);
  state.currentRound.position = 0;
  state.currentRound.correctThisRound = 0;
  roundFinished = false;
}

function startNewRound() {
  buildRoundQuestionList();
  state.stats.roundsPlayed++;
  state.stats.currentStreak = 0;
  saveState();
  updateUI();
  showNextQuestion();
}

function showNextQuestion() {
  if (state.currentRound.position >= TOTAL_PER_ROUND) {
    finishRound();
    return;
  }

  const id = state.currentRound.questionList[state.currentRound.position];
  currentQuestion = getKanaById(id);

  document.getElementById("kanaDisplay").textContent = currentQuestion.char;

  const options = generateChoices(currentQuestion);
  ["choice1","choice2","choice3"].forEach((btnId, i) => {
    const btn = document.getElementById(btnId);
    btn.textContent = options[i].text;
    btn.dataset.correct = options[i].correct ? "1" : "0";
    btn.disabled = false;
    btn.style.background = "#e0e0ff";
    btn.style.color = "#000";
  });

  document.getElementById("feedback").textContent = "";
  document.getElementById("roundEnd").style.display = "none";
  document.getElementById("questionNumber").textContent =
    state.currentRound.position + 1;

  updateUI();
}

function finishRound() {
  roundFinished = true;
  document.getElementById("roundCorrect").textContent =
    state.currentRound.correctThisRound;
  document.getElementById("roundEnd").style.display = "block";
  checkBadges();
  renderBadges();
}

function handleChoiceClick(e) {
  if (!currentQuestion || roundFinished) return;
  const btn = e.currentTarget;
  const isCorrect = btn.dataset.correct === "1";

  ["choice1","choice2","choice3"].forEach(id => {
    document.getElementById(id).disabled = true;
  });

  state.stats.totalSeen++;

  const feedback = document.getElementById("feedback");

  if (isCorrect) {
    state.stats.totalCorrect++;
    state.currentRound.correctThisRound++;
    state.stats.currentStreak++;
    const points = 10 + Math.max(0, state.stats.currentStreak - 1);
    state.stats.score += points;

    if (state.stats.currentStreak > state.stats.maxStreak)
      state.stats.maxStreak = state.stats.currentStreak;

    btn.style.background = "#22c55e";
    btn.style.color = "#fff";
    feedback.textContent =
      `Correct! ‚Üí ${currentQuestion.romaji}`;
    feedback.className = "feedback correct";

    const entry = state.reviewPool[currentQuestion.id];
    if (entry) {
      entry.seen++;
      if (entry.seen >= 3 && entry.wrongCount <= entry.seen / 2) {
        delete state.reviewPool[currentQuestion.id];
      }
    }

  } else {
    state.stats.currentStreak = 0;
    btn.style.background = "#ef4444";
    btn.style.color = "#fff";
    feedback.textContent =
      `Wrong‚Ä¶ ${currentQuestion.char} = ${currentQuestion.romaji}`;
    feedback.className = "feedback wrong";

    if (!state.reviewPool[currentQuestion.id]) {
      state.reviewPool[currentQuestion.id] = { wrongCount: 1, seen: 0 };
    } else {
      state.reviewPool[currentQuestion.id].wrongCount++;
    }
  }

  saveState();
  renderMistakes();

  setTimeout(() => {
    state.currentRound.position++;
    showNextQuestion();
  }, 700);
}

/* ==========================
   Badges & mistakes
   ========================== */
function addBadge(id) {
  if (!state.stats.badges.includes(id))
    state.stats.badges.push(id);
}
function checkBadges() {
  const s = state.stats;
  if (s.totalSeen >= 10) addBadge("first10");
  if (s.totalSeen >= 50) addBadge("fifty");
  if (s.maxStreak >= 5) addBadge("combo5");
  if (s.maxStreak >= 10) addBadge("combo10");
  if (s.totalCorrect >= 100) addBadge("hundred");
  if (state.currentRound.correctThisRound === TOTAL_PER_ROUND)
    addBadge("perfect");
}
function renderBadges() {
  const box = document.getElementById("badgeList");
  box.innerHTML = "";
  if (state.stats.badges.length === 0) {
    box.textContent = "No badges yet. Keep playing!";
    return;
  }
  const names = {
    first10: "10 questions",
    fifty: "50 questions",
    combo5: "Combo 5",
    combo10: "Combo 10",
    hundred: "100 correct",
    perfect: "Perfect round"
  };
  state.stats.badges.forEach(id => {
    const div = document.createElement("div");
    div.className = "badge";
    div.textContent = names[id] || id;
    box.appendChild(div);
  });
}

function renderMistakes() {
  const box = document.getElementById("mistakeList");
  box.innerHTML = "";
  const entries = Object.entries(state.reviewPool)
    .sort((a,b) => b[1].wrongCount - a[1].wrongCount);
  if (entries.length === 0) {
    box.textContent = "No mistakes!";
    return;
  }
  entries.forEach(([id, info]) => {
    const k = getKanaById(id);
    const row = document.createElement("div");
    row.className = "mistake-item";
    row.innerHTML =
      `<span>${k.char} ‚Üí ${k.romaji}</span><span>${info.wrongCount}</span>`;
    box.appendChild(row);
  });
}

/* ==========================
   Audio
   ========================== */
function playKanaAudio() {
  if (!currentQuestion) return;
  if (!("speechSynthesis" in window)) return;
  const u = new SpeechSynthesisUtterance(currentQuestion.char);
  u.lang = "ja-JP";
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* ==========================
   Storage & UI
   ========================== */
function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn("Could not save state", e);
  }
}
function loadState() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
      state = Object.assign(state, JSON.parse(data));
    } else {
      initLearningQueue();
    }
  } catch (e) {
    console.warn("Could not load state", e);
    initLearningQueue();
  }
}
function updateUI() {
  document.getElementById("score").textContent  = state.stats.score;
  document.getElementById("streak").textContent = state.stats.currentStreak;
  document.getElementById("maxStreak").textContent = state.stats.maxStreak;
  document.getElementById("roundCount").textContent = state.stats.roundsPlayed;
}

/* ==========================
   Init
   ========================== */
function initLearningQueue() {
  state.learningQueue = shuffle(KANA_LIST.map(k => k.id));
  state.index = 0;
}

function init() {
  loadState();
  if (!state.learningQueue || state.learningQueue.length !== KANA_LIST.length) {
    initLearningQueue();
  }
  renderMistakes();
  renderBadges();
  updateUI();
  startNewRound();

  document.getElementById("choice1").onclick = handleChoiceClick;
  document.getElementById("choice2").onclick = handleChoiceClick;
  document.getElementById("choice3").onclick = handleChoiceClick;

  document.getElementById("playAudioBtn").onclick = playKanaAudio;
  document.getElementById("nextRoundBtn").onclick = startNewRound;
}

window.onload = init;
</script>
</body>
</html>
